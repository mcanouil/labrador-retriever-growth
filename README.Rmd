---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

# Labrador Retriever Growth

<!-- badges: start -->
[![License](https://img.shields.io/github/license/mcanouil/labrador-retriever-growth)](LICENSE)
[![Render README](https://github.com/mcanouil/labrador-retriever-growth/actions/workflows/render-readme.yaml/badge.svg)](https://github.com/mcanouil/labrador-retriever-growth/actions/workflows/render-readme.yaml)
<!-- badges: end -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "media/",
  fig.process = function(path) {
    new_path <- sub("-1\\.", ".", path)
    new_path <- sub("-1\\.", ".", path)
    file.copy(path, new_path, overwrite = TRUE)
    on.exit(unlink(normalizePath(path)))
    new_path
  },
  dev = "svg",
  echo = FALSE,
  message = FALSE
)
dir.create(knitr::opts_chunk$get("fig.path"), showWarnings = FALSE)

pkgs <- c(
  "targets", "here",
  "svglite", "ggplot2", "ggtext", "patchwork", "scales",
  "ggrepel", "ggfx", "data.table", "readxl", "showtext"
)
# renv::snapshot(packages = c("rmarkdown", pkgs))
invisible(sapply(
  X = pkgs,
  FUN = library, character.only = TRUE, quietly = TRUE
))

tar_unscript()

font <- "Alegreya Sans"
sysfonts::font_add_google(font, font, regular.wt = 300)
showtext::showtext_auto()
source("https://raw.githubusercontent.com/mcanouil/xaringan-template/main/assets/setup-ggplot2-mc.R")
```

```{targets example-globals, tar_globals = TRUE}
tar_option_set(
  packages = c(
    "here",
    "svglite", "ggplot2", "ggtext", "patchwork", "scales",
    "ggrepel", "ggfx", "data.table", "readxl", "showtext"
  )
)

should_glow <- FALSE

font <- "Alegreya Sans"
sysfonts::font_add_google(font, font, regular.wt = 300)
showtext::showtext_auto()
source("https://raw.githubusercontent.com/mcanouil/xaringan-template/main/assets/setup-ggplot2-mc.R")
```

```{targets raw-data}
tar_target(raw_data, {
  setnames(
    x = setDT(
      read_excel(
        path = here("data/nash-nora-2021.xls"),
        col_names = FALSE,
        range = "C11:M68"
      )
    ),
    old = sub(" ", "", toupper(apply(setDT(
      read_excel(here("data/nash-nora-2021.xls"), col_names = FALSE, n_max = 10)
    )[j = -c(1, 2)], 2, function(x) paste(c(toupper(x[2]), x[9:10]), collapse = "_"))))
  )[
    j = lapply(.SD, function(x) as.numeric(sub("GR$", "", x)))
  ][
    j = day := as.integer(sub("naissance", "0", sub(".* ", "", read_excel(
      path = here("data/nash-nora-2021.xls"),
      col_names = FALSE,
      range = "A11:A68"
    )[[1]])))
  ]
})
```

```{targets tidy-data}
tar_target(tidy_data, {
  melt(
    data = raw_data[
      j = .SD[rowSums(is.na(.SD)) == 0]
    ][
      j = date := as.Date("2021-09-06") + day
    ][
      j = day := NULL
    ],
    id.vars = "date",
    value.name = "weight",
    variable.name = "dog_id"
  )[
    j = outlier := !between(weight, median(weight) - 4 * IQR(weight), median(weight) + 4 * IQR(weight)),
    by = "date"
  ][
    j = c("id", "sex", "colour") := tstrsplit(dog_id, "_")
  ][
    j = `:=`(
      sex = factor(sex, levels = c("F", "M"), labels = c("Female", "Male")),
      colour = factor(colour, levels = c("SABLE", "NOIR"), labels = c("Yellow", "Black"))
    )
  ][
    i = !(outlier),
    j = c("y", "ymin", "ymax") := mean_se(weight),
    by = "date"
  ]
})
```

```{targets growth-plot}
tar_target(growth_plot, {
  ggplot(tidy_data) +
    aes(x = date, y = weight) +
    {
      if (should_glow) {
        with_outer_glow(
          geom_path(mapping = aes(colour = id)),
          colour = "#FFFFFF",
          sigma = 1
        )
      } else {
        geom_path(mapping = aes(colour = id), size = 0.75)
      } 
    } +
    # geom_point(aes(colour = id, shape = outlier), size = 1) +
    geom_text_repel(
      data = ~ .x[!(outlier)][date == max(date)],
      mapping = aes(colour = id, label = id),
      nudge_x = 2,
      direction = "y",
      min.segment.length = 0,
      size = 5,
      hjust = 0
    ) +
    geom_path(
      data = ~ unique(.x[!(outlier), list(date, y, ymin, ymax)]),
      mapping = aes(x = date, y = y),
      colour = "#FFFFFF",
      linetype = 2, 
      size = 0.75,
      inherit.aes = FALSE
    ) +
    scale_x_date(
      date_breaks = "1 week",
      date_labels = "%d/%m<br>%Y",
      expand = expansion(add = c(0, 12))
    ) +
    scale_y_continuous(
      labels = number_format(big.mark = ",", scale = 1e-3),
      expand = expansion(c(0, 0.25))
    ) +
    scale_colour_viridis_d(begin = 0.50, end = 1) +
    scale_shape_manual(values = c(16, 4)) +
    coord_cartesian(ylim = range(c(0, tidy_data[!(outlier), weight]))) +
    labs(x = NULL, y = "Weight (kg)") +
    theme(  
      legend.position = "none", 
      panel.grid.major = element_line(size = ggplot2::rel(0.5)), 
      panel.grid.minor = element_line(size = ggplot2::rel(0.25))
    ) +
    facet_grid(rows = vars(paste(colour, sex)))
})
```

```{targets growth-plot-id}
tar_target(growth_plot_id, {
  p <- ggplot(tidy_data) +
    aes(x = date, y = weight) +
    geom_path(
      data = ~ unique(.x[!(outlier), list(date, y, ymin, ymax)]),
      mapping = aes(x = date, y = y),
      colour = "#FFFFFF",
      linetype = 2, 
      size = 0.75,
      inherit.aes = FALSE
    ) +
    scale_x_date(
      date_breaks = "1 week",
      date_labels = "%d/%m<br>%Y",
      expand = expansion(add = c(0, 1))
    ) +
    scale_y_continuous(
      labels = number_format(big.mark = ",", scale = 1e-3),
      expand = expansion(c(0, 0.25))
    ) +
    scale_colour_viridis_d(begin = 0.50, end = 1) +
    scale_shape_manual(values = c(16, 4)) +
    coord_cartesian(ylim = range(c(0, tidy_data[!(outlier), weight]))) +
    labs(x = NULL, y = "Weight (kg)") +
    theme(  
      legend.position = "none", 
      panel.grid.major = element_line(size = ggplot2::rel(0.5)), 
      panel.grid.minor = element_line(size = ggplot2::rel(0.25))
    )

  lapply(
    X = unique(tidy_data[["id"]]),
    FUN = function(idog) {
      p +
      geom_path(data = ~.x[id %in% idog], mapping = aes(colour = id), size = 1) +
      geom_point(data = ~.x[id %in% idog], mapping = aes(colour = id, shape = outlier), size = 2) +
      labs(title = idog)
    }
  )
})
```

```{r tar-make, include = FALSE}
tar_make()
```

```{r growth}
#| fig.width = 8,
#| fig.height = 11.5,
#| fig.cap = "Weight growth curves from birth for eleven Labrador Retriever",
#| dev = c("svglite", "ragg")

tar_read(growth_plot)
```

```{r growth-id}
#| fig.width = 8,
#| fig.height = 6,
#| fig.cap = "Weight growth curves from birth for eleven Labrador Retriever",
#| dev = c("svglite", "ragg"),
#| fig.process = identity,
#| results = "asis"

lp <- tar_read(growth_plot_id)
for (p in lp) {
  cat(sprintf("## %s\n\n", p$labels$title))
  print(p)
}
```